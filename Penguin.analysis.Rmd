---
title: "Palmer Penguin Analyses"
output:
  html_document:
    toc: true
    toc_depth: 2          
    toc_float: true       
    code_folding: hide
date: "2024-12-09"
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages

```{r, message = FALSE, warning = FALSE}
library(palmerpenguins)
library(ggplot2)
library(janitor)
library(dplyr)
library(here)
library(svglite)
library(car)
library(ggsignif)
library(broom)
library(ggpubr)
library(rstatix)
library(knitr)
library(kableExtra)
```

### Load the data

```{r, include=TRUE}
penguins_raw <- read.csv(here("data", "penguins_raw.csv"))
```

# **Section 1:** Data Visualization for Science Communication

```{r echo=FALSE, warning=FALSE, fig.align='center', message = FALSE}

Cherry_pick_data <- penguins_raw

penguins_filtered <- penguins_raw %>%
  filter(
    `Culmen.Length..mm.` > 33,  # Remove points with length below 40
    `Culmen.Depth..mm.` < 30   # Remove points with depth above 20
  )

ggplot(penguins_filtered, aes(x = `Culmen.Depth..mm.`, y = `Culmen.Length..mm.`, shape = Sex, color = Sex)) +
  geom_point(size = 5, alpha = 1.0) +  # Add points
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Single trend line 
  labs(x = "depth", y = "length", title = "Comparing lengths") +  # Add axis labels and title
  theme(
    axis.title = element_text(size = 5),  # Adjust size of axis titles
    plot.title = element_text(size = 12),  # Adjust size of the plot title
    legend.text = element_text(size = 5),  # Adjust size of legend text
    legend.title = element_text(size = 10) # Adjust size of legend title
  )+
  scale_y_continuous(limits = c(30, 55)) +  # Shrink the y-axis range
  scale_x_continuous(limits = c(10, 25))  # Shrink the x-axis range

```

### b) Write about how your design choices mislead the reader about the underlying data (200-300 words).

The presented figure employs multiple design features that mislead the viewer and misrepresent the underlying data, reflecting common issues in scientific reporting and reproducibility. Nature performed and survery and found that 70% of researchers have tried and failed to reproduce another scientist's work and more than half have failed to reproduce their own experiments [@baker2016reproducibility]. There are multiple forces leading to the lack of reproducibility like the pressure to publish and selective reporting. the figure displayed above is a good example of misleading data representation. It appears as though there is a negative correlation between Culmen length and depth. However, further inspection of the data would reveal that that within each species there is a positive correlation between length and depth, which has been obscured by grouping the data together. This is known as simpson's paradox. This data was also filtered to exclude extreme values that may obscure the relationship, this is known as cherry picking. Both cherry picking and Simpson's paradox are common in closed journed. This figure also has multiple aesthetic problems which interferes with interpretation. The labels and title are small and ambiguous (e.g. lack units and specification of the lengths/ depth measured). The data points are large and overlapping, making it hard to understand their true disritbution. Finally, the scale does not starts at zero, exagerating the negative slop and the data points are clumped in the middle of the graph. Overall, this makes it hard for the viewer to understand the graph, and what they can gather is likely to be misleading.

There is a push for more open access, open data, open source and other open scholarship practices. The potential benefits (e.g. media attention and potential collaborators) associated with open science are helping it to rise in popularity. However, at the moment there is not enough public evidence of the effectiveness of open publishing for all scientists to comply [@mckiernan2016open].

------------------------------------------------------------------------

# **Section 2:** Data Pipeline

# [Introduction]{.underline}

> Gentoo, Adelie, and Chinstrap are three species in penguin that are found in the Palmer Archipelago near Antarctica. This analysis seeks to determine whether these species occupy different feeding niches by comparing their bill morphology, specifically the culmen depth. Morphological plasticity in bill size has been shown to relate closely to diet and thus niche differentiation [@laranjeiro2022variation]. Specifically, culmen depth plays a crucial role in determining the strength and functionality of a penguin's bill, directly influencing the types of prey the species can access. A deeper bill typically allows for the capture and handling of larger, more robust prey, while a shallower bill may be more suited to feeding on smaller or more agile prey. This study will compare the culmen depth of these species to gain insights into niche differentiation.

### Cleaning and filtering the data

```{r, include=TRUE}

#Save a raw copy of the data before cleaning it. 
write.csv(penguins_raw, "data/penguins_raw.csv")

#Load the Function to clean the data 
source(here("Functions", "Cleaning.R"))

#Clean the data 
penguins_clean <- Cleaning(penguins_raw) #See annotation within the cleaning function

#Save the cleaned data set 
write.csv(penguins_clean, "data/penguins_clean.csv")

#Select the collumn that will be analysed (culmen_depth_mm) and remove rows with NA. This ensures NA are only removed from the collumn being used. 
penguins_clean_subset <- penguins_clean %>% select(culmen_depth_mm, species) %>% remove_NA()

```

### Visualising the data

```{r echo=TRUE, warning=FALSE, fig.align='center', message = FALSE}

# Plot a histogram of all the raw data 
Flipper.Histogram <- ggplot(penguins_clean_subset, aes(x = culmen_depth_mm, fill = species)) +  # Load ggplot2 and prepare the plot
  geom_histogram(alpha = 0.6, position = "identity", binwidth = 0.3) +  # Add a histogram layer with transparency and overlapping positions
  labs(
    title = "Culmen Depth Distribution of the Palma Pengiuns",
    x = "Culmen Depth Length (mm)",
    y = "Frequency",
    caption = "Figure 1: Histogram showing the distribution of culmen depth measurements (in mm) for different penguin \n species, highlighting similarities and variations in culmen depth between species") + # Add labels for the title and axes
  theme(
    plot.caption = element_text(hjust = 0, size = 9) # Align the caption to the left and size it
  ) + theme_bw()

# Display the plot
print(Flipper.Histogram)

```

### Saving the figure 
```{r, message=FALSE, warning=FALSE}
# I now want to save this plot by calling the save function
source(here("Functions", "SavingFigure.R")) # Details in the function file

# Apply the function
save_flipper_plot_svg(Flipper.Histogram,
                      here("Figures", "Flipper.Histogram.svg"), size = 25, scaling = 1.5)
```

### Summary statistics

```{r}
#Call the summary function

source(here("Functions", "Summary.R")) #Details in the function file 

#Run the function 
summarize_data(penguins_clean_subset, "species", "culmen_depth_mm", "Summary Statistics of Beak Depth (mm) by Year")
                
```

### Insight from exploration and cleaning

> The data, sourced from the palmerpenguin R package, includes various measurements collected from 344 penguins, representing three species: Adelie, Gentoo, and Chinstrap. The exploratory plot and summary statistics reveal that Adelie and Chinstrap penguins have similar culmen lengths, while Gentoo penguins exhibit greater variation. Statistical analysis is required to assess the significance of these differences.

# [Hypothesis]{.underline}


:::: hypothesis
::: {style="border: 2px solid #000; padding: 10px; background-color: #f9f9f9; border-radius: 5px;"}
**H0:** There is no significant difference between the Culmen Depth of the Palma Penguins.

**H1:** There is no significant difference between the Culmen Depth of the Palma Penguins.
:::
::::

# [Methods - statistical analyses]{.underline}

> A fixed linear model was created, with species as the explanatory variable and culmen depth as the response variable. Residual and QQ plots were utilized to evaluate model assumptions, revealing that the data satisfied the homoscedasticity assumption (confirmed by the Levene's test) but violated the normality assumption (confirmed by the Shapiro-Wilk test). However, the QQ plot showed only minor deviations from normality, and given the large sample size, linear models are generally robust to such slight violations so the data was not transformed. A one-way ANOVA was then performed to assess whether the mean culmen lengths between species were significantly different, with significance determined at α=0.05. Finally, a pairwise comparison with a Bonferroni adjustment, accounting for Type I error, was performed to confirm the pairwise differences.

### Linear model formation

```{r, include=TRUE}

# Generate a linear model 
Culmen_model <- lm(culmen_depth_mm ~ species, data = penguins_clean_subset) #Fixed linear model with species as a the explanatory variable and culmen length as the response variable 
```

### Checking assumptions: graphical assessment

The residual plot shows there is no violation of homoscedasticity in the residuals while the QQ plot shows minor normality violations.

```{r echo=TRUE, warning=FALSE, fig.align='center', message = FALSE}

#Load the Function to check the assumptions 
source(here("Functions", "AssumptionCheck.R")) #Details in the function file 

#Apply the function 
Assumption_check(Culmen_model, "Figure 2: The evenness of the residual spread in the three clusters (species) suggests no \n violation of homoscedasticity.\n Figure 3: Residuals mostly follow the diagonal, with slight tail deviations suggesting minor normality \n  violations.") #Function requires the model and the caption to be specified. 

```

### Checking assumptions: Statistical assessment

Levene's test for homogeneity of variance was not significant, indicating no violation the homoscedasity assumption. However, the Shapiro-Wilk test for normality was significant, suggesting a violation of normality. Since this test is highly sensitive, especially with large sample sizes, and linear models are robust to slight deviations from normality, I am not going to transform the data.

```{r, include=TRUE}

# Perform Levene's Test
levene_result <- leveneTest( culmen_depth_mm ~ factor(species), data = penguins_clean_subset)

# Perform Shapiro-Wilk Test
shapiro_result <- shapiro.test(penguins_clean_subset$culmen_depth_mm)


#Create a results table 
results_table <- data.frame(
  Test = c("Shapiro-Wilk", "Levene's Test"),
  Statistic = c(round(shapiro_result$statistic, 3), round(levene_result$`F value`[1], 3)),
  P_Value = c(formatC(shapiro_result$p.value, format = "e", digits = 3),
              formatC(levene_result$`Pr(>F)`[1], format = "e", digits = 3))
)

#display the results table 
kable(
  results_table,
  col.names = c("Test", "Test Statistic", "P-Value"),
  caption = "Test Results for Shapiro-Wilk and Levene's Test"
)%>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```

### ANOVA
```{r, include=TRUE}

#Perform an ANOVA on the model 
anova_result <- Anova(Culmen_model)

# Convert ANOVA result to a data frame
anova_table <- as.data.frame(anova_result)


# Add meaningful column names
colnames(anova_table) <- c("Sum Sq", "Df", "F Value", "P-Value")

# Apply consistent formatting to p-values (ensures P is not displayed as 0)
anova_table$`P-Value` <- formatC(anova_table$`P-Value`, format = "e", digits = 3)

# Display the ANOVA table 
kable(
  anova_table,
  caption = "ANOVA Results",
  digits = 3, # Round to 3 decimal places
  col.names = c("Sum of Squares", "Degrees of Freedom", "F Value", "P-Value")
) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```

### Pairwise comparison
```{r, include=TRUE}
#Perform the pairwise comparison 
pwc <-  penguins_clean_subset %>%
  pairwise_t_test(
    culmen_depth_mm ~ species, paired = FALSE,
    p.adjust.method = "bonferroni"
  )

#Create a table 
pwc_table <- pwc %>%
  select(group1, group2, p, p.adj) %>%
  mutate(
    p = formatC(p, format = "e", digits = 3),       # Format p-values in scientific notation
    p.adj = formatC(p.adj, format = "e", digits = 3) # Format adjusted p-values in scientific notation
  )

# Display the formatted table
kable(
  pwc_table,
  caption = "Pairwise Comparisons with Bonferroni Adjustment",
  col.names = c("Group 1", "Group 2", "P-Value", "Adjusted P-Value")
)%>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```

# [Results and discussion]{.underline}

> The results of the one way ANOVA (F(2, 339) = 259.79, p \< 0.001), confirmed that the overall difference between these species is significant, so the null hypothesis can be rejected. However, the pairwise comparison revealed that there is no significant difference between Adelie and Chinstrap, while both Adelie and Chinstrap significantly differ from Gentoo. These results are depicted in figure 4.

> From these results it appears Adelie and Chinstrap and more likely to prey on the same species and thus inhabit a similar feeding niche compared to Gentoo. These findings correlate with what we know about penguin feeding ecology supporting that Culmen depth is a good proxy. The Adelie and Chinstrap penguin have more similar diets (eat primarily krill), than the Gentoo penguin which is more generalist (eat a mixture of crustaceans, small fish, and squid).

> However, it is important to note that while culmen depth can provide insight into the general foraging behavior and feeding niche, the culmen length may also be a crucial factor in shaping their feeding ecology. Differences in culmen length could reveal additional patterns in prey selection and feeding behavior, potentially indicating that all three species inhabit slightly different feeding niches. Other factors like body size will also contribute to prey selection. If considered alone, these results may imply that Adelie and Chinstrap occupy exactly the same feeding niche. Further analysis is required to compare other morphological features like culmen length and body size between the three species.

```{r echo=TRUE, warning=FALSE, fig.align='center', message = FALSE}

# Create a box plot including the results of the ANOVA and the pwc
Results.figure <- ggplot(data = penguins_clean_subset, aes(x = penguins_clean_subset$species, y = culmen_depth_mm)) +  # Load ggplot2 and prepare the plot
  geom_boxplot(aes(fill = species), alpha = 0.7, width = 0.5) +  # Add box plot layer
  labs(
    y = "Culmen Depth (mm)", 
    x = "Species", 
    title = "Comparing the Culmen Depth of the Palma Penguins",
    subtitle = "ANOVA, F(2, 339) = 359.79, p < 0.0001", 
    caption = "Figure 4: Box plot comparing the culmen depth of the 3 species of Palma Penguin.  Includes the results of the \n ANOVA which are significant ( P<0.0001) and the Pairwise comparisons with Bonferroni correction"
  ) +  # Labeling 
  stat_pvalue_manual(pwc, y.position = c(23, 24, 25)) +  # Add pwc results 
  scale_y_continuous(limits = c(13, 25)) +  # Position pwc lines 
  theme_bw() +  # Set the theme 
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 9),
    plot.caption = element_text(size = 10), 
    legend.position = "none"  # Edit font sizes and positions
  )

print(Results.figure)
  
```

### Saving the figure 

```{r, message=FALSE, warning=FALSE}

#The save function has already been called so just need to apply the function 
save_flipper_plot_svg(Results.figure,
                      here("Figures", "Results.figure.svg"), size =25, scaling = 1.5)
```

# [Conclusion]{.underline}

> In conclusion, the null hypothesis that there is no difference between the three culmen depths can be rejected. While the Adelie and Chinstrap penguins exhibit similar culmen depths, the Gentoo penguins demonstrate a significantly different culmen depth, and these patterns relate to their feeding niches. However, further analysis of other traits affecting the prey available is required to further define how their morphology impacts their feeding niche. Even so, this is an interesting example of how morphological divergence is involved in niche specialization within an genera to reduce competition and allow co-existence. Different combinations of penguin species are found on Torgersen, Dream, and Biscoe Islands; however, all three species never coexist on the same island. It would be interesting to investigate whether the presence of different species on an island influences their unique ecological specializations.

# [References]{.underline}

::: {#refs}
:::

------------------------------------------------------------------------
# **Section 3:** Open Science

### a) GitHub

*Upload your RProject you created for **Question 2** and any files and subfolders used to GitHub. Do not include any identifiers such as your name. Make sure your GitHub repo is public.*

*GitHub link:*

*You will be marked on your repo organisation and readability.*

### b) Share your repo with a partner, download, and try to run their data pipeline.

*Partner's GitHub link:*

*You **must** provide this so I can verify there is no plagiarism between you and your partner.*

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

-   *Did it run? Did you need to fix anything?*

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

-   *What did you learn about writing code for other people?* ::::
